<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Call Hanna</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .avatar-container {
            position: relative;
            width: 220px;
            height: 220px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .avatar-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #06C755 0%, #00a347 100%);
            position: absolute;
            z-index: 2;
            box-shadow: 0 8px 32px rgba(6, 199, 85, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 80px;
        }

        .avatar-circle::after {
            content: 'ü©∫';
        }

        /* Pulse Animation */
        .pulse-ring {
            position: absolute;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: rgba(6, 199, 85, 0.25);
            z-index: 1;
            transform: scale(1);
        }

        .pulsing .pulse-ring {
            animation: pulse-animation 2s infinite;
        }

        @keyframes pulse-animation {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .brand-name {
            margin-top: 20px;
            font-size: 32px;
            font-weight: 700;
            color: #06C755;
            letter-spacing: 2px;
        }

        .status-text {
            margin-top: 16px;
            font-size: 22px;
            font-weight: 500;
            color: #eee;
            text-align: center;
        }

        .subtitles {
            margin-top: 24px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.75);
            text-align: center;
            padding: 16px 24px;
            min-height: 60px;
            max-width: 320px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .controls {
            margin-top: 48px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .btn-end {
            background: linear-gradient(135deg, #ff4757 0%, #ff3b30 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(255, 59, 48, 0.35);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-end:active {
            transform: scale(0.95);
        }

        .btn-start {
            background: linear-gradient(135deg, #06C755 0%, #00a347 100%);
            color: white;
            padding: 20px 60px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            display: none;
            box-shadow: 0 8px 32px rgba(6, 199, 85, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-start:active {
            transform: scale(0.95);
        }

        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #start-screen p {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        /* Hidden initially */
        #call-ui {
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .error-text {
            color: #ff4757;
        }
    </style>
</head>

<body>

    <!-- Start Screen -->
    <div id="start-screen">
        <div class="avatar-container">
            <div class="avatar-circle"></div>
        </div>
        <div class="brand-name">HANNA</div>
        <button id="btn-connect" class="btn-start" style="display:block; margin-top: 40px;">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Æ‡∏±‡∏ô‡∏ô‡∏≤</button>
        <p style="margin-top:20px; color:#aaa">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</p>
    </div>

    <!-- Call UI -->
    <div id="call-ui">
        <div class="avatar-container">
            <div class="pulse-ring"></div>
            <div class="pulse-ring" style="animation-delay: 1s;"></div>
            <div class="avatar-circle"></div>
        </div>

        <div class="status-text" id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>
        <div class="subtitles" id="transcript"></div>

        <div class="controls">
            <button class="btn-end" onclick="endCall()">‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢</button>
        </div>
    </div>

    <script>
        let recognition;
        let isSpeaking = false;
        let userId = 'guest-' + Date.now();

        async function init() {
            // Initialize LIFF
            try {
                await liff.init({ liffId: "2008593893-Bj5k3djg" });
                console.log('LIFF initialized successfully');

                // Get user profile if logged in
                if (liff.isInClient() && liff.isLoggedIn()) {
                    try {
                        const profile = await liff.getProfile();
                        userId = profile.userId;
                        console.log('User ID:', userId);
                    } catch (e) {
                        console.warn('Could not get profile:', e.message);
                    }
                }
            } catch (e) {
                console.warn('LIFF init failed:', e.message);
            }

            document.getElementById('btn-connect').addEventListener('click', startCall);
        }

        async function startCall() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";

            try {
                // Check for Web Speech API support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    throw new Error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech API");
                }

                // Start voice interface
                setupVoice();
                document.getElementById('status').innerText = "‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞";

            } catch (err) {
                console.error(err);
                document.getElementById('status').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
            }
        }

        function endCall() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) { }
            }

            // Close LIFF or go back
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }

        function setupVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                document.getElementById('status').innerText = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech API";
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = true;  // Keep listening continuously
            recognition.interimResults = false;

            recognition.onstart = () => {
                console.log('Recognition started');
                if (!isSpeaking) {
                    document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
                    document.body.classList.remove('pulsing');
                }
            };

            recognition.onend = () => {
                console.log('Recognition ended, restarting...');
                // Auto-restart only if session is still active
                if (!isSpeaking) {
                    recognition.start();
                }
            };

            recognition.onerror = (event) => {
                console.log('Speech recognition error:', event.error);
                // Don't restart on every error - just log it
                if (event.error === 'aborted' || event.error === 'no-speech') {
                    // These are expected, recognition will auto-restart via onend
                }
            };

            recognition.onresult = async (event) => {
                // Get the latest result (continuous mode gives multiple results)
                const resultIndex = event.resultIndex;
                const text = event.results[resultIndex][0].transcript;

                if (text.trim() && !isSpeaking) {
                    document.getElementById('transcript').innerText = `‡∏Ñ‡∏∏‡∏ì: ${text}`;
                    // Process the message (don't await - let recognition continue)
                    processUserAudio(text);
                }
            };

            // Start listening once - permission requested here only
            recognition.start();
        }

        async function processUserAudio(text) {
            if (isSpeaking) return; // Prevent overlapping responses

            isSpeaking = true;

            document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...";
            document.body.classList.add('pulsing');

            try {
                const res = await fetch('/api/voice/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, userId })
                });

                const data = await res.json();

                document.getElementById('transcript').innerText = `‡∏Æ‡∏±‡∏ô‡∏ô‡∏≤: ${data.text}`;
                document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î...";

                // Play Audio
                if (data.audio) {
                    const audio = new Audio("data:audio/mp3;base64," + data.audio);

                    audio.onended = () => {
                        isSpeaking = false;
                        document.body.classList.remove('pulsing');
                        document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
                    };

                    audio.onerror = () => {
                        isSpeaking = false;
                        document.body.classList.remove('pulsing');
                        document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
                    };

                    await audio.play();
                } else {
                    isSpeaking = false;
                    document.body.classList.remove('pulsing');
                    document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
                }

            } catch (e) {
                console.error("AI Error", e);
                isSpeaking = false;
                document.body.classList.remove('pulsing');
                document.getElementById('status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
            }
        }

        // Initialize on load
        init();
    </script>
</body>

</html>